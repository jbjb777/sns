<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>í”„ë¡œí•„ - Sharer</title>
  <link rel="icon" type="image/svg+xml" href="./logo.svg" />
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ê·¸ëŒ€ë¡œ ìœ ì§€ (ìƒëµ) */
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #121212;
      color: #fff;
      min-height: 100vh;
      display: flex;
      animation: fadeIn 0.4s ease-out forwards;
    }
    /* â€¦ ë‚˜ë¨¸ì§€ ìŠ¤íƒ€ì¼ë“¤ â€¦ (ìƒëµ) */
    .skeleton { /* â€¦ */ }
    @keyframes loading { /* â€¦ */ }
    @media (max-width: 768px) { /* â€¦ */ }
  </style>
</head>
<body>

<div class="sidebar-container">
  <iframe src="sidebar.html" id="sidebarFrame" width="250" height="100%" frameborder="0"></iframe>
</div>

<div class="main-wrapper">
  <div class="header">
    <button class="back-btn" onclick="goBack()">â†</button>
    <div class="header-title">í”„ë¡œí•„</div>
  </div>

  <div class="container">
    <div id="profileContent">
      <!-- ì´ˆê¸° ìŠ¤ì¼ˆë ˆí†¤ -->
      <div class="profile-card">
        <div class="profile-header">
          <div class="skeleton skeleton-avatar"></div>
          <div class="profile-info" style="flex:1;">
            <div class="skeleton skeleton-text" style="width:250px;"></div>
            <div class="profile-stats">
              <div class="skeleton skeleton-stat"></div>
              <div class="skeleton skeleton-stat"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="posts-section">
      <div class="section-title">ê²Œì‹œë¬¼</div>
      <div id="userPosts">
        <div class="post-grid">
          <!-- ìŠ¤ì¼ˆë ˆí†¤ ê²Œì‹œë¬¼ë“¤ -->
          <div class="post-item">
            <div class="skeleton skeleton-post-image"></div>
            <div class="post-item-content">
              <div class="skeleton skeleton-post-text"></div>
              <div class="skeleton skeleton-post-text" style="width:80%;"></div>
            </div>
          </div>
          <!-- â€¦ ë” ìˆìŒ â€¦ -->
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <div class="footer-links">
      <a href="#" onclick="showPrivacyPolicy(); return false;">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
      <a href="#" onclick="showTerms(); return false;">ì´ìš©ì•½ê´€</a>
      <a href="mailto:alexeom97@outlook.com">ë¬¸ì˜í•˜ê¸°</a>
    </div>
    <div class="footer-text">Â© 2025 ã‹¡ê§ì •ë¹ˆ777ê§‚ SNS. All rights reserved.</div>
  </div>
</div>

<!-- ìƒíƒœë©”ì‹œì§€ ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal-overlay" id="statusModal">
  <div class="modal-content">
    <div class="modal-title">ìƒíƒœë©”ì‹œì§€ ìˆ˜ì •</div>
    <textarea class="modal-input" id="statusInput" placeholder="ìƒíƒœë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." maxlength="100"></textarea>
    <div class="modal-buttons">
      <button class="modal-btn modal-btn-cancel" onclick="closeStatusModal()">ì·¨ì†Œ</button>
      <button class="modal-btn modal-btn-confirm" onclick="saveStatusMessage()">í™•ì¸</button>
    </div>
  </div>
</div>

<!-- ìˆ¨ê²¨ì§„ íŒŒì¼ ì…ë ¥ (í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œìš©) -->
<input type="file" id="profileFileInput" accept="image/*" style="display:none;">

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = "https://hoeevmstbhulbzqyfsug.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "sb_publishable_QQCVYix-A8r3vCipAnu0Xg_hST_0xBa";

const supabase = createClient(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);

const urlParams = new URLSearchParams(window.location.search);
const userId = urlParams.get('id');
const userNickname = urlParams.get('nickname');

let currentUser = null;
let viewingUser = null;

function initCurrentUser() {
  const savedUser = localStorage.getItem('snsUser');
  if (savedUser) {
    currentUser = JSON.parse(savedUser);
    updateSidebar();
  }
}

function updateSidebar() {
  const iframe = document.getElementById('sidebarFrame');
  if (iframe?.contentWindow) {
    iframe.contentWindow.postMessage({ type: 'updateUser', user: currentUser }, '*');
  }
}

function updateSidebarMode() {
  const iframe = document.getElementById('sidebarFrame');
  const narrow = window.innerWidth <= 768;
  if (iframe?.contentWindow) {
    iframe.contentWindow.postMessage({ type: 'setNarrowMode', narrow }, '*');
  }
}

window.addEventListener('message', (event) => {
  const { type, page } = event.data || {};
  if (type === 'navigate') {
    if (page === 'home') location.href = 'index.html';
    if (page === 'explore') location.href = 'explore.html';
  }
  if (type === 'logout') {
    localStorage.removeItem('snsUser');
    currentUser = null;
    location.href = 'index.html';
  }
  if (type === 'requestUserInfo') {
    updateSidebar();
  }
});

initCurrentUser();
updateSidebarMode();
window.addEventListener('resize', updateSidebarMode);

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œ ì´ë²¤íŠ¸ â€” â˜…í•œ ë²ˆë§Œ ë“±ë¡â˜…
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('profileFileInput').addEventListener('change', async (e) => {
  const file = e.target.files?.[0];
  if (!file || !currentUser) return;

  console.log('ğŸ“‚ íŒŒì¼ ì„ íƒë¨:', file.name);

  const fileExt = file.name.split('.').pop() || 'png';
  const safeUserId = currentUser.nickname;           // â† í•µì‹¬: nickname ì‚¬ìš©
  const fileName = `profiles/${safeUserId}/profile.${fileExt}`;

  console.log('ğŸ“¤ ì—…ë¡œë“œ ì‹œë„ ê²½ë¡œ:', fileName);

  try {
    const { error: uploadError } = await supabase.storage
      .from('images')
      .upload(fileName, file, { upsert: true });

    if (uploadError) throw uploadError;

    const { data: urlData } = supabase.storage
      .from('images')
      .getPublicUrl(fileName);

    const imageUrl = urlData.publicUrl;

    const { error: dbError } = await supabase
      .from('users')
      .update({ profile_image: imageUrl })
      .eq('nickname', currentUser.nickname);

    if (dbError) throw dbError;

    console.log('âœ… ì—…ë¡œë“œ & DB ì—…ë°ì´íŠ¸ ì„±ê³µ');

    // í™”ë©´ ì¦‰ì‹œ ê°±ì‹ 
    viewingUser.profile_image = imageUrl;
    await displayProfile(viewingUser);

    // ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡ ì´ˆê¸°í™”
    e.target.value = '';
  } catch (err) {
    console.error('âŒ í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œ/ì €ì¥ ì‹¤íŒ¨:', err);
    alert('í”„ë¡œí•„ ì‚¬ì§„ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n' + (err.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
  }
});

if (!userId && !userNickname) {
  showError('ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
} else {
  loadUserProfile();
  loadUserPosts();
}

async function loadUserProfile() {
  try {
    let userData = null;
    const { data, error } = await supabase
      .from('users')
      .select('*')
      .eq('nickname', userNickname)
      .single();

    if (userNickname === "JB777" || userNickname === "ì§„ì •ì˜¤") {
      if (error || !data) {
        userData = {
          nickname: userNickname,
          id: userNickname.toLowerCase(),
          isVerified: true,
          message: null,
          profile_image: null
        };
      } else {
        userData = { ...data, isVerified: true };
      }
    } else {
      if (error || !data) {
        showError('ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      userData = data;
    }

    viewingUser = userData;
    await displayProfile(userData);
  } catch (e) {
    console.error('í”„ë¡œí•„ ë¡œë“œ ì˜¤ë¥˜:', e);
    showError('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

async function displayProfile(user) {
  const contentDiv = document.getElementById('profileContent');
  const isVerified = user.nickname === "JB777" || user.nickname === "ì§„ì •ì˜¤" || user.isVerified;
  const isOwnProfile = currentUser && currentUser.nickname === user.nickname;

  const { data: posts } = await supabase
    .from('posts')
    .select('id')
    .eq('author', user.nickname);
  const postCount = posts?.length ?? 0;

  let totalLikes = 0;
  const { data: userPosts } = await supabase
    .from('posts')
    .select('id')
    .eq('author', user.nickname);

  if (userPosts?.length) {
    for (const post of userPosts) {
      const { data: likes } = await supabase
        .from('likes')
        .select('id', { count: 'exact' })
        .eq('post_id', post.id);
      totalLikes += likes?.length ?? 0;
    }
  }

  const statusMessage = user.message || '';
  const statusDisplay = statusMessage
    ? `<div class="status-message-text">${escapeHtml(statusMessage)}</div>`
    : `<div class="status-message-text status-message-empty">ìƒíƒœë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;

  const editButton = isOwnProfile
    ? `<button class="edit-status-btn" onclick="openStatusModal()" title="ìƒíƒœë©”ì‹œì§€ ìˆ˜ì •">
         <img src="pencil.png" alt="ìˆ˜ì •">
       </button>`
    : '';

  let avatarHtml = user.profile_image
    ? `<img src="${user.profile_image}" class="profile-avatar-img${isOwnProfile ? ' editable' : ''}" alt="í”„ë¡œí•„ ì‚¬ì§„">`
    : `<div class="profile-avatar${isOwnProfile ? ' editable' : ''}">${user.nickname?.[0]?.toUpperCase() ?? '?'}</div>`;

  contentDiv.innerHTML = `
    <div class="profile-card">
      <div class="profile-header">
        ${avatarHtml}
        <div class="profile-info">
          <div class="profile-name">
            ${escapeHtml(user.nickname)}
            ${isVerified ? '<span class="verification-badge"></span>' : ''}
          </div>
          <div class="profile-stats">
            <div class="stat-item">
              <div class="stat-number">${postCount}</div>
              <div class="stat-label">ê²Œì‹œë¬¼</div>
            </div>
            <div class="stat-item">
              <div class="stat-number">${totalLikes}</div>
              <div class="stat-label">ì¢‹ì•„ìš”</div>
            </div>
            <button class="share-btn" id="shareBtn" onclick="copyProfileLink()" title="í”„ë¡œí•„ ë§í¬ ë³µì‚¬">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
      <div class="status-message-container">
        ${statusDisplay}
        ${editButton}
      </div>
    </div>
  `;

  // ë³¸ì¸ í”„ë¡œí•„ â†’ ì•„ë°”íƒ€ í´ë¦­ ì‹œ íŒŒì¼ ì„ íƒì°½ ì—´ê¸°
  if (isOwnProfile) {
    const avatarElement = contentDiv.querySelector('.profile-avatar, .profile-avatar-img.editable');
    if (avatarElement) {
      avatarElement.onclick = () => {
        console.log('ğŸ–± í”„ë¡œí•„ ì‚¬ì§„ í´ë¦­ â†’ íŒŒì¼ ì„ íƒì°½ ì—´ê¸°');
        document.getElementById('profileFileInput').click();
      };
    }
  }
}

// ë‚˜ë¨¸ì§€ í•¨ìˆ˜ë“¤ (loadUserPosts, displayPosts, escapeHtml, goBack ë“±)ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
// â€¦ (ìƒëµ) â€¦

// (í•„ìš”í•œ ë‚˜ë¨¸ì§€ í•¨ìˆ˜ë“¤ â€” openStatusModal, saveStatusMessage, showError, copyProfileLink ë“±)
window.openStatusModal = function() { /* â€¦ ê¸°ì¡´ ì½”ë“œ â€¦ */ }
window.closeStatusModal = function() { /* â€¦ */ }
window.saveStatusMessage = async function() { /* â€¦ */ }
window.goBack = () => window.history.back();
window.showPrivacyPolicy = () => window.location.href = "privacy.html";
window.showTerms = () => window.location.href = "policy.html";
window.copyProfileLink = function() { /* â€¦ */ }

function escapeHtml(t) {
  if (!t) return '';
  return t.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m]));
}

function showError(msg) { /* â€¦ */ }
</script>
</body>
</html>
